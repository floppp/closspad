#+TITLE: deploy.sh Improvement Tasks

* Overview
  Tracking improvements to deploy.sh for simplification and cleanup.

* Step 1: Verify Critical Typos [CRITICAL]
  **Status:** COMPLETED - NO ISSUES FOUND
  **Lines:** 98, 168
  **Description:** Verified syntax is correct (initial analysis was mistaken)
  - Line 98: `${input_version#v}` - CORRECT bash parameter expansion
  - Line 168: `${version#v}` - CORRECT bash parameter expansion
  - No typos exist, syntax was already correct
  - No changes needed to deploy.sh
  **Impact:** Verified - no fixes required
  **Note:** Initial analysis incorrectly identified these as typos, but they are valid syntax

* Step 2: Add Missing Rollback on Build Failure [CRITICAL]
  **Status:** COMPLETED
  **Lines:** 212-215, 220-223
  **Description:** Call rollback() if build steps fail
  - Line 213: Added rollback() call after npx shadow-cljs release app failure
  - Line 221: Added rollback() call after cp command failure
  - Previously exited without calling rollback, leaving modified files
  **Impact:** Ensures clean state when build fails

* Step 3: Remove Unused Variable
  **Status:** COMPLETED
  **Lines:** 150-152 (removed)
  **Description:** Removed unused wildcard case statement
  - Removed `*) other_args+=("$arg")` case
  - Variable was never used anywhere in script
  - Reduces code complexity
  **Impact:** Cleaner, more maintainable code

* Step 4: Refine Verbosity
  **Status:** COMPLETED
  **Lines:** 46-91, 154, 175-176, 182-183, 204-205 (modified/removed)
  **Description:** Removed excessive debug noise, kept essential output
  **Removed:**
    - All get_last_version debug prints (Starting version detection, Found CHANGELOG.md, etc.)
    - "NEW_MAIN value: %s" debug print (line 154)
    - "Checking index.html before/after update" (lines 175, 182)
    - grep calls showing script tags (lines 176, 183)
    - "Build artifacts:" + ls -la output (lines 204-205)
  **Kept:**
    - Version increment messages (e.g., "Auto-incrementing patch version to: v0.4.22")
    - "Creating versioned file: main.v0.4.22.js"
    - "Cleaning old version files..."
    - Error messages
    - rsync progress (built-in)
  **Impact:** Cleaner output during normal operation, reduced noise

* Step 5: Simplify Version Logic
  **Status:** COMPLETED
  **Lines:** 142-145 (consolidated)
  **Description:** Consolidated version_with_v assignment
  - Replaced two lines with single assignment
  - Changed from:
    - version_with_v=${version#v}
    - version_with_v="v$version_with_v"
  - To: version_with_v="v${version#v}"
  **Impact:** Cleaner, more readable code

* Step 6: Consolidate Sed Commands
  **Status:** COMPLETED
  **Lines:** 172-174 (consolidated)
  **Description:** Combined 3 sed calls into 1
  - Replaced 3 separate sed commands with 1 using multiple -e flags
  - More efficient single file read/write operation
  **Impact:** More efficient, cleaner code

* Step 7: Reorder Functions
  **Status:** COMPLETED
  **Lines:** Moved from 234, 246 to 13, 22
  **Description:** Moved rollback() and clean() to top of script
  - Moved functions from middle of script (lines 234, 246)
  - Placed after SSH key check (line 8)
  - Added dedicated "Functions" section (lines 10-30)
  - Follows better scripting conventions
  **Impact:** Functions available earlier, better code organization

* Step 8: Simplify get_last_version()
  **Status:** COMPLETED
  **Lines:** 68-93 (simplified)
  **Description:** Flattened structure with early returns
  - Removed nested if-else statements
  - Used early returns: [ ! -z "$version" ] && echo "$version" && return 0
  - Each version source (CHANGELOG, git tags, JS files) now returns early when found
  - Much flatter, more readable code
  - Kept all core version detection logic
  **Impact:** More readable, maintainable code

* Step 9: Simplify increment_version()
  **Status:** TODO
  **Lines:** 94-118
  **Description:** Remove redundant validation
  - Line 106 validation is redundant (line 99 already validates format)
  - Simplify function logic
  **Impact:** Cleaner code

* Step 10: Extract Configuration
  **Status:** TODO
  **Lines:** Top of script, 243-251
  **Description:** Move hardcoded values to configuration variables
  - Add: PUBLIC_DIR="resources/public"
  - Add: REMOTE_SERVER="nando@157.90.230.213:/home/nando/apps/qoback/fik"
  - Add: RSYNC_EXCLUDES="--exclude 'js/cljs-runtime' ..."
  - Replace hardcoded values in code
  **Impact:** Easier to maintain, changeable values in one place

* Step 11: Improve Error Handling
  **Status:** TODO
  **Lines:** 253-256, git push section
  **Description:** Replace brittle $? checks with direct conditionals
  - Change `command; if [ $? -ne 0 ]; then` to `if ! command; then`
  - Apply to rsync command
  - Apply to git push command
  **Impact:** More robust error handling, cleaner code

* Progress Summary
  - Total Steps: 11
  - Completed: 8
  - Pending: 3
