#!/bin/bash

# SSH key check
if [ -z "$SSH_AUTH_SOCK" ]; then
    eval $(ssh-agent -s)
    ssh-add ~/.ssh/id_ed25519
    fi

# ======================================================================
# Configuration
# ======================================================================
PUBLIC_DIR="resources/public"
REMOTE_SERVER="nando@157.90.230.213:/home/nando/apps/qoback/fik"
RSYNC_EXCLUDES="--exclude 'js/cljs-runtime' --exclude 'js/main.js' --exclude 'portfolio.html' --exclude 'portfolio-js' --exclude '*.edn' --exclude '*.bak'"

# ======================================================================
# Functions
# ======================================================================

rollback() {
    echo "Deployment failed. Rolling back changes..."
    rm -f $PUBLIC_DIR/css/style.v*.css
    rm -f $PUBLIC_DIR/tailwind.v*.css
    rm -f $PUBLIC_DIR/js/main.v*.js
    mv $PUBLIC_DIR/index.html.bak $PUBLIC_DIR/index.html
    echo "Rollback complete. No commit was created."
}

clean() {
    # Clean old versions
    rm $PUBLIC_DIR/*.bak
    rm -rf $PUBLIC_DIR/portfolio-js
    rm $PUBLIC_DIR/js/main.v*.js
    rm $PUBLIC_DIR/js/manifest.edn
    rm $PUBLIC_DIR/css/style.v*.css
    rm $PUBLIC_DIR/tailwind.v*.css
}

get_last_version() {
    # Try CHANGELOG.md first
    if [ -f CHANGELOG.md ]; then
        local version=$(head -n 1 CHANGELOG.md | grep -o "^v[0-9]*\.[0-9]*\.[0-9]* [a-f0-9]\{40\}" | cut -d' ' -f1 || echo "")
        [ ! -z "$version" ] && echo "$version" && return 0
    fi

    # Try git tags
    local version=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
    [ ! -z "$version" ] && echo "$version" && return 0

    # Try JS files
    local version=$(ls $PUBLIC_DIR/js/main.v*.js 2>/dev/null | sed 's/.*main\.\(v[0-9]*\.[0-9]*\.[0-9]*\)\.js/\1/' | sort -V | tail -n 1)
    [ ! -z "$version" ] && echo "$version" && return 0

    # Default
    echo "v0.0.1"
}

increment_version() {
    local input_version=$1
    local upgrade_minor=$2
    # Strip any leading 'v' if present
